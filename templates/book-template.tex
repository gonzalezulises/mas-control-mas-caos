\documentclass[$if(fontsize)$$fontsize$,$endif$$if(papersize)$$papersize$paper,$endif$twoside,openright]{book}

% Español
\usepackage[spanish]{babel}
\usepackage[utf8]{inputenc}

% Fuentes y tipografía
\usepackage{fontspec}
\setmainfont{TeX Gyre Termes}
\setsansfont{TeX Gyre Heros}
\setmonofont{DejaVu Sans Mono}[Scale=0.85]

% Geometría de página
\usepackage[$for(geometry)$$geometry$$sep$,$endfor$]{geometry}

% Espaciado
\usepackage{setspace}
$if(linestretch)$
\setstretch{$linestretch$}
$endif$

% Encabezados y pies de página
\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhf{}
\fancyhead[LE]{\small\leftmark}
\fancyhead[RO]{\small\rightmark}
\fancyfoot[LE,RO]{\thepage}
\renewcommand{\headrulewidth}{0.4pt}
\renewcommand{\footrulewidth}{0pt}

% Páginas de capítulo sin encabezado
\fancypagestyle{plain}{
  \fancyhf{}
  \fancyfoot[LE,RO]{\thepage}
  \renewcommand{\headrulewidth}{0pt}
}

% Títulos de capítulo
\usepackage{titlesec}
\titleformat{\chapter}[display]
  {\normalfont\huge\bfseries}
  {\chaptertitlename\ \thechapter}
  {20pt}
  {\Huge}
\titlespacing*{\chapter}{0pt}{50pt}{40pt}

% Párrafos
\setlength{\parindent}{1.5em}
\setlength{\parskip}{0.5em}

% Links y URLs
\usepackage{xurl}  % DEBE ir antes de hyperref
\usepackage{hyperref}
\hypersetup{
  colorlinks=true,
  linkcolor=black,
  urlcolor=blue,
  breaklinks=true,
  pdfauthor={$author$},
  pdftitle={$title$},
  pdfsubject={$description$}
}

% Corte agresivo de URLs largas
\makeatletter
\g@addto@macro\UrlBreaks{\UrlOrds}
\g@addto@macro\UrlBreaks{%
  \do\a\do\b\do\c\do\d\do\e\do\f\do\g\do\h\do\i\do\j%
  \do\k\do\l\do\m\do\n\do\o\do\p\do\q\do\r\do\s\do\t%
  \do\u\do\v\do\w\do\x\do\y\do\z%
  \do\A\do\B\do\C\do\D\do\E\do\F\do\G\do\H\do\I\do\J%
  \do\K\do\L\do\M\do\N\do\O\do\P\do\Q\do\R\do\S\do\T%
  \do\U\do\V\do\W\do\X\do\Y\do\Z%
  \do\0\do\1\do\2\do\3\do\4\do\5\do\6\do\7\do\8\do\9%
}
\makeatother

% Permitir más flexibilidad en el corte de líneas
\emergencystretch=3em
\tolerance=1000
\hbadness=10000

% Gráficos
\usepackage{graphicx}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\makeatother
\setkeys{Gin}{width=\maxwidth,keepaspectratio}

% Código y bloques
\usepackage{fancyvrb}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\},fontsize=\small}

% Epígrafes y citas
\usepackage{csquotes}
\renewcommand{\mkbegdispquote}[2]{\itshape}

% Notas al pie
\usepackage[bottom]{footmisc}

% Tabla de contenidos
\setcounter{tocdepth}{1}

% Listas compactas (requerido por pandoc)
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}

% Listas
\usepackage{enumitem}

% Símbolos matemáticos
\usepackage{amssymb}
\usepackage{amsmath}

% Tablas largas
\usepackage{longtable}
\usepackage{booktabs}
\usepackage{array}
\usepackage{calc}

\begin{document}

% Portada
\begin{titlepage}
\centering
\vspace*{3cm}
{\Huge\bfseries $title$\par}
\vspace{1cm}
$if(subtitle)$
{\Large\itshape $subtitle$\par}
$endif$
\vspace{2cm}
{\Large $author$\par}
\vfill
{\large $date$\par}
\end{titlepage}

% Página legal
\thispagestyle{empty}
\vspace*{\fill}
\begin{center}
\small
$rights$\\[1cm]
Primera edición: $date$\\[0.5cm]
$if(publisher)$
$publisher$
$endif$
\end{center}
\newpage

% Tabla de contenidos
\tableofcontents
\cleardoublepage

% Contenido principal
\mainmatter
$body$

\end{document}
